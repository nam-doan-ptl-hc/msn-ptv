<div id="dashboard-container">
  <div class="row">
    <div class="col-sm-4">
      <h2>Dashboard page</h2>
    </div>
    <div class="col-sm-8 d-flex justify-content-end">
      <input
        type="text"
        [(ngModel)]="searchText"
        (keyup.enter)="onSearch()"
        placeholder="Search patients"
        class="p-2 mb-3 border rounded w-full"
      />
    </div>
  </div>
  <div class="div-loading" *ngIf="isLoading">
    <mat-progress-spinner
      [diameter]="40"
      mode="indeterminate"
      color="warn"
    ></mat-progress-spinner>
  </div>
  <table
    *ngIf="!isLoading"
    mat-table
    [dataSource]="dataSource"
    matSort
    class="mat-elevation-z8 table-dashboard"
  >
    <!-- Cá»™t Checkbox -->
    <ng-container matColumnDef="select">
      <th mat-header-cell *matHeaderCellDef>
        <mat-checkbox
          color="primary"
          (change)="masterToggle()"
          [checked]="isAllSelected()"
          [indeterminate]="selection.hasValue() && !isAllSelected()"
          [aria-label]="checkboxLabel()"
        >
        </mat-checkbox>
      </th>
      <td mat-cell *matCellDef="let row">
        <mat-checkbox
          color="primary"
          (click)="$event.stopPropagation()"
          (change)="$event ? selection.toggle(row) : null"
          [checked]="selection.isSelected(row)"
          [aria-label]="checkboxLabel(row)"
        >
        </mat-checkbox>
      </td>
    </ng-container>
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Patient Name</th>
      <td mat-cell *matCellDef="let element">{{ getPatientName(element) }}</td>
    </ng-container>

    <ng-container matColumnDef="account">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Contact Info</th>
      <td mat-cell *matCellDef="let element">
        {{ element?.patient?.phone_number || element?.patient?.email }}
      </td>
    </ng-container>

    <ng-container matColumnDef="code">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        CareProgram State
      </th>
      <td mat-cell *matCellDef="let element">
        {{ getCPState(element.permission, element.default_hds_record) }}
      </td>
    </ng-container>
    <ng-container matColumnDef="health_data">
      <th class="text-center" mat-header-cell *matHeaderCellDef>Health Data</th>
      <td
        class="column-health d-flex justify-content-center"
        mat-cell
        *matCellDef="let element"
      >
        <div>
          <a
            href="/dashboard-hds"
            *ngIf="isShowHealthData(element); else noData"
            target="_blank"
          >
            <p class="d-flex justify-content-center">
              <img src="/assets/images/ic-db-new.svg" alt="Has Health Data" />
            </p>
            <p class="d-flex p-date">
              <i class="material-icons"></i>
              <span>{{
                getStringTimeSync(
                  element?.patient_ref?.extended_attributes?.hds_last_sync
                )
              }}</span>
            </p>
          </a>
          <ng-template #noData
            ><p
              class="p-nodata d-flex justify-content-center align-items-center"
            >
              <span>--</span>
            </p></ng-template
          >
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>

  <div class="row">
    <div class="col-sm-5">
      <div class="d-flex d-select">
        <select
          class="form-select"
          [(ngModel)]="bulkAction"
          (ngModelChange)="onBulkActionChange($event)"
          [disabled]="selection.isEmpty()"
        >
          <option value="">Bulk Action</option>
          <option value="0">Stop CareProgram</option>
          <option value="1">Delete CareProgram</option>
        </select>
        <div *ngIf="selection.selected.length > 0" class="btn-inform-clear-row">
          <span>Selected Rows: {{ selection.selected.length }}</span>
          <span
            class="btn-clear-row"
            role="button"
            tabindex="0"
            style="cursor: pointer"
            (click)="selection.clear()"
            >(Clear All)</span
          >
        </div>
      </div>
    </div>
    <div class="col-sm-7">
      <mat-paginator
        [length]="totalRecords"
        [pageSize]="pageSize"
        [pageSizeOptions]="[5, 10, 25, 100]"
        showFirstLastButtons
      >
      </mat-paginator>
    </div>
  </div>
</div>
<!-- Bulk Action Modal -->
<div
  class="modal fade"
  id="bulkActionModal"
  tabindex="-1"
  aria-labelledby="bulkActionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkActionModalLabel">Stop CareProgram</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        Once a CareProgram is stopped, it will be removed from patient's app.
        You will be able to see the CareProgram progress on this dashboard.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-danger"
          (click)="onConfirmBulkAction()"
        >
          Submit
        </button>
      </div>
    </div>
  </div>
</div>
